<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Google Maps Sliding Marker Move Demo</title>

    <link href="map.css" rel="stylesheet" />

    <script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script src="https://code.jquery.com/jquery.min.js"></script>
    <script src="lib/jquery.easing.1.3.js"></script>
    <script src="lib/markerAnimate.js"></script>
    <script src="lib/SlidingMarker.js"></script>
	<script>
        SlidingMarker.initializeGlobally();
    </script>
	<script src="lib/markerwithlabel.terikon.js"></script>
	<script src="lib/collections.min.js"></script>

    <script>
		var markers;
        var map;
		var mapOptions;
		var coords = [new google.maps.LatLng(32.520204, 34.937258), new google.maps.LatLng(52.520204, 54.937258)];
		var intervalId = 0;
		var actions;
		var actionId = 0;
		var $log;
		
        function initialize() {
            mapOptions = {
                zoom: 4,
                center: coords[0],
                mapTypeId: google.maps.MapTypeId.ROADMAP
            }
            map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);
            $log = $("#log");
            $log.html();
        }

		function printEvent(instance, eventName) {
                google.maps.event.addListener(instance, eventName, function () {
                    console.log("Event: " + eventName);
                });
        }

		function buttonHandler(event) {
				if (actions == null) {
                    return;
                }
				if (actionId == actions.length) {
                    actionId = 0;
					$log.html("");
                }
				
				var key = Object.keys(actions[actionId]);
				if (actionId == 0) {
                    actionId++;
                }
				
				if (key == "Sync") {
                    for (i = 0; i < actions[actionId][key].length; i++) {
                        handleAction(actions[actionId][key][i])
                    }
				} else {
					handleAction(actions[actionId])
				}
				actionId++;
		}

		function handleAction(action) {
			var key = Object.keys(action);
            if (key == "Detection") {
				$log.html($log.html() + action[key]["Robot"] + " detects<br/>");
            } else if (key == "UnicastCommunication") {
				$log.html($log.html() + "Message sent to " + action[key]["Target"] + "<br/>");
            } else if (key == "Action") {
                $log.html($log.html() + action[key]["Robot"] + " does " + action[key]["Action"] + "<br/>");
				if (action[key]["Action"] == "Move") {
					markers.get(action[key]["Robot"]).setDuration(duration);
					markers.get(action[key]["Robot"]).setEasing("linear");
					markers.get(action[key]["Robot"]).setPosition(new google.maps.LatLng(action[key]["Properties"]["Lat"],
															  action[key]["Properties"]["Long"]));
                }
			} else if (key == "BroadcastCommunication") {
                //code
            } else if (key == "MulticastCommunication") {
                //code
            } else if (key == "UnicastCommunication") {
                //code
            } else if (key == "Status") {
                //code
            }
		}
		
        $(function () {
            initialize();
	
			var myLatlng = new google.maps.LatLng(33.520204, 33.937258);
	
//            var clickHandler = function (event, clickType) {
//                var duration = parseInt($('#durationOption').val());
//				alert(clickType);
//                if (duration < 0) {
//                    duration = 1;
//                    $('#durationOption').val(duration);
//                }
//
//                marker.setDuration(duration);
//				marker.setEasing("linear");
//
//                if (clickType === "left") {
//                    marker.setPosition(event.latLng);
//                } else if (clickType === "right"){
//                    marker.setPositionNotAnimated(event.latLng);
//                } else if (clickType === "button"){
//					marker.setPosition(coords[1]);
//				}
//            };
            
            //var leftClickHandler = function(event) { clickHandler(event, "left") };
            //var rightClickHandler = function(event) { clickHandler(event, "right") };

            //google.maps.event.addListener(map, 'click', leftClickHandler);
            //google.maps.event.addListener(map, 'rightclick', rightClickHandler);
			
			var nextButtonClickHandler = function(event) {
				window.clearInterval(intervalId);
				intervalId = 0;
				buttonHandler(event);
			}
			
			document.getElementById("nextButton").addEventListener("click", nextButtonClickHandler);
			document.getElementById("autoButton").addEventListener("click", function() {
				intervalId = setInterval(function() {
					buttonHandler();
					}, 1000
				);
			});


            var printEvent = function (instance, eventName) {
                google.maps.event.addListener(instance, eventName, function () {
                    console.log("Event: " + eventName);
                });
            };

            if (window.location.hash == "#iframe") {
                $('#backLink').hide();
                $('#controls').css('height', '55px');
            }

        });
		
	
	var duration = parseInt($('#durationOption').val());
    if (duration < 0) {
        duration = 1;
        $('#durationOption').val(duration);
	}

	$(document).on('change', '.file-upload-button', function(event) {
		var reader = new FileReader();

		reader.onload = function(event) {
			actions = JSON.parse(event.target.result);
			markers = new Map();
			for (i = 0; i < actions[0]["Status"]["Robots"].length; i++) {
				var name = actions[0]["Status"]["Robots"][i]["Robot"];
				var lat = actions[0]["Status"]["Robots"][i]["Lat"];
				var long = actions[0]["Status"]["Robots"][i]["Long"];
				
				markers.set(name, new MarkerWithLabel({
					position: new google.maps.LatLng(lat, long),
	                map: map,
					title: 'Robot',
					labelContent: name
					})
				);
				
				map.setCenter(markers.get(name).getPosition())
			}
			
			document.getElementById("nextButton").style.visibility = "visible";
			document.getElementById("autoButton").style.visibility = "visible";
		}

		reader.readAsText(event.target.files[0]);
	});

    </script>
</head>
<body>
    <div id="map_canvas"></div>

    <div id="controls" class="control">
        <div class="row">
			<input class='file-upload-button' id="selectedFile" type="file" title=" " style="display: none;" />
			<input type="button" value="Browse..." onclick="document.getElementById('selectedFile').click();" />
		</div>
		<div class="row">
            <label for="durationOption">Duration:</label>
            <input type="number" id="durationOption" value="1000"><p\>
		</div>
		<div class="row">
			<button id="nextButton"  style="visibility:hidden;">Next</button>
		</div>
		<div class="row">
			<button id="autoButton" style="visibility:hidden;">Auto</button>
        </div>
        <div class="row" id="backLink">
            <a href="https://github.com/terikon/marker-animate-unobtrusive">Source &rarr;</a>
        </div>
    </div>

    <div id="log" class="control">
    </div>

</body>
</html>